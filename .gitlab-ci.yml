stages:
  - validate
  - test
  - build
  - deploy
  - cleanup

variables:
  AWS_REGION: "us-east-1"
  TF_ROOT: "terraform/environments/dev"
  ECR_registry: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
  APP_NAME: "demo-ml-app"

image: hashicorp/terraform:light

before_script:
  - apk add --no-cache curl python3 py3-pip jq git
  - pip3 install awscli

cache:
  paths:
    - ${TF_ROOT}/.terraform

# Terraform Validation
terraform_validate:
  stage: validate
  script:
    - cd ${TF_ROOT}
    - terraform init -backend=false
    - terraform validate
    - terraform fmt -check

# Security Scanning
tfsec:
  stage: test
  image: aquasec/tfsec-ci
  script:
    - tfsec .

trivy_fs:
  stage: test
  image: aquasec/trivy
  script:
    - trivy fs --exit-code 0 --no-progress .

# Build Sample ML App
build_ml_app:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_registry
  script:
    - cd kubernetes/applications/${APP_NAME}
    - docker build -t $ECR_registry/gitops/dev/ml-models:${CI_COMMIT_SHORT_SHA} .
    - docker push $ECR_registry/gitops/dev/ml-models:${CI_COMMIT_SHORT_SHA}
  rules:
    - changes:
        - kubernetes/applications/demo-ml-app/**/*

# Infrastructure Deployment (Plan)
terraform_plan:
  stage: deploy
  script:
    - cd ${TF_ROOT}
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    expire_in: 1 day

# Infrastructure Deployment (Apply)
terraform_apply:
  stage: deploy
  script:
    - cd ${TF_ROOT}
    - terraform init
    - terraform apply -auto-approve tfplan
  needs:
    - terraform_plan
  when: manual
  only:
    - main

# Argo CD Sync (post-deploy)
sync_argocd:
  stage: deploy
  image: argoproj/argocd:latest
  script:
    - argocd app sync app-of-apps --server argocd.example.com --auth-token $ARGOCD_TOKEN
  allow_failure: true
  needs:
    - terraform_apply
  when: manual
